<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Final Audit – Coinify</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,700&family=Plus+Jakarta+Sans:wght@300;400;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/static/css/styles.css" />
</head>
<body class="assessment-bg min-h-screen text-white">
  <div class="texture-overlay"></div>

  <!-- Pre-call: intro screen -->
  <div id="introView" class="min-h-screen p-8 flex flex-col items-center justify-center text-center relative">
    <div class="mb-12">
      <div class="w-24 h-24 bg-white/10 rounded-full mx-auto flex items-center justify-center mb-6 border border-white/20">
        <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
      </div>
      <h1 class="serif text-4xl italic mb-4">The Loan Officer</h1>
      <p class="text-zinc-400 max-w-xs mx-auto text-sm leading-relaxed">You are calling "The Grand National". Your goal: listen to the script and complete the assessment to prove your knowledge.</p>
    </div>
    <button id="initiateBtn" class="bg-white text-zinc-900 px-12 py-4 rounded-full font-bold tracking-widest hover:scale-110 transition-transform">
      INITIATE CALL
    </button>
    <a href="/static/home.html" class="block mx-auto mt-8 text-xs text-zinc-500 underline underline-offset-4">Return to dashboard</a>
  </div>

  <!-- Calling: active call screen -->
  <div id="callingView" class="hidden min-h-screen p-8 flex flex-col items-center space-y-12 relative">
    <div class="relative mt-8">
      <div class="pulse-ring absolute inset-0 bg-white/10 rounded-full scale-150"></div>
      <div class="pulse-ring absolute inset-0 bg-white/5 rounded-full scale-[2]" style="animation-delay: 0.5s"></div>
      <div class="w-32 h-32 bg-white rounded-full flex items-center justify-center relative z-10">
        <div class="flex gap-1">
          <div class="w-1 h-8 bg-zinc-900 animate-bounce" style="animation-delay: 0.1s"></div>
          <div class="w-1 h-12 bg-zinc-900 animate-bounce" style="animation-delay: 0.2s"></div>
          <div class="w-1 h-6 bg-zinc-900 animate-bounce" style="animation-delay: 0.3s"></div>
          <div class="w-1 h-10 bg-zinc-900 animate-bounce" style="animation-delay: 0.4s"></div>
        </div>
      </div>
    </div>

    <div class="space-y-4 text-center">
      <p class="mono text-xs text-zinc-500 uppercase tracking-[0.3em]">Connected via Eleven Labs AI</p>
      <p class="serif text-xl italic text-zinc-300">"Hello, this is the loan officer. How can I help you today?"</p>
    </div>

    <div class="w-full max-w-lg space-y-4">
      <div class="p-4 bg-white/5 border border-white/20 rounded-xl">
        <p class="text-[10px] mono text-zinc-500 uppercase mb-2">Script</p>
        <div id="script" class="text-sm text-zinc-300 whitespace-pre-wrap max-h-32 overflow-y-auto"></div>
      </div>
      <div class="flex gap-2">
        <button id="playBtn" class="flex-1 py-3 rounded-xl border border-white/30 font-semibold hover:bg-white/10 transition-colors">Play call (voice)</button>
        <button id="stopBtn" class="py-3 px-4 rounded-xl border border-white/30 font-semibold hover:bg-white/10 transition-colors" disabled>Stop</button>
      </div>
      <p id="voiceNote" class="text-xs text-zinc-500 hidden">Using browser voice (no API key).</p>
      <button id="endCallBtn" class="w-full py-3 bg-red-500/20 border border-red-500/50 rounded-xl text-sm font-bold uppercase tracking-widest text-red-200 hover:bg-red-500/30 cursor-pointer transition-colors">End Call</button>
      <button id="completeBtn" class="w-full py-4 bg-white text-zinc-900 rounded-full font-bold">I've listened – Complete assessment</button>
    </div>
  </div>

  <script src="/static/js/api.js"></script>
  <script>
    let currentSource = null;
    let scriptText = '';

    (async () => {
      const me = await getMe();
      if (!me || !me.user) { window.location.href = '/static/login.html'; return; }
      const scriptData = await getCallSimulatorScript();
      scriptText = (scriptData && scriptData.script) ? scriptData.script : 'No script loaded.';
      document.getElementById('script').textContent = scriptText;
    })();

    document.getElementById('initiateBtn').addEventListener('click', () => {
      document.getElementById('introView').classList.add('hidden');
      document.getElementById('callingView').classList.remove('hidden');
    });

    function stopPlayback() {
      if (currentSource) {
        try {
          if (currentSource.pause) currentSource.pause();
          if (currentSource.src && currentSource.src.startsWith('blob:')) URL.revokeObjectURL(currentSource.src);
        } catch (_) {}
        currentSource = null;
      }
      if (window.speechSynthesis) window.speechSynthesis.cancel();
      document.getElementById('playBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
    }

    document.getElementById('playBtn').addEventListener('click', async () => {
      const text = (scriptText || (document.getElementById('script') && document.getElementById('script').textContent) || '').trim();
      if (!text) return;
      document.getElementById('playBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
      try {
        const res = await fetchElevenLabsSpeech(text);
        if (res.ok) {
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const audio = new Audio(url);
          currentSource = audio;
          audio.onended = () => stopPlayback();
          audio.onerror = () => { stopPlayback(); fallbackSpeech(text); };
          audio.play();
          return;
        }
      } catch (e) { console.warn('ElevenLabs speech failed', e); }
      fallbackSpeech(text);
    });

    function fallbackSpeech(text) {
      if (!window.speechSynthesis) { document.getElementById('playBtn').disabled = false; document.getElementById('stopBtn').disabled = true; return; }
      const u = new SpeechSynthesisUtterance(text.substring(0, 5000));
      u.onend = () => stopPlayback();
      document.getElementById('voiceNote').classList.remove('hidden');
      window.speechSynthesis.speak(u);
    }

    document.getElementById('stopBtn').addEventListener('click', stopPlayback);

    document.getElementById('endCallBtn').addEventListener('click', () => {
      stopPlayback();
      document.getElementById('callingView').classList.add('hidden');
      document.getElementById('introView').classList.remove('hidden');
    });

    document.getElementById('completeBtn').addEventListener('click', async () => {
      stopPlayback();
      await completeCallSimulator();
      alert('Assessment complete! You earned the Call Pro badge and 50 XP.');
      window.location.href = '/static/home.html';
    });
  </script>
</body>
</html>
